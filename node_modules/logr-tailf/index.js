var spawn = require('child_process').spawn;

var getEventMessage = function(data, options) {
  return {
    'type':'event',
    'payload': {
      'type':'tailf',
      'file':options.file,
      'message':JSON.stringify(data)
    },
  };
}

var tailf;


module.exports = {

  processPayload: function(eventPayload) {
    console.log("PROCESS", eventPayload);
    eventPayload.message = eventPayload.message.replace(/\\"/g,'"').replace(/(^"|"$)+/g,'').replace(/\\n$/g,'');
    return eventPayload;
  },

  initialize: function(options, connection) {
    console.log("INIT", options);
    tailf = spawn("tailf", ['-n', '1', options.file]);
    tailf.stdout.setEncoding("UTF8");
    tailf.stdout.on("data", function(data) {
      connection.write(JSON.stringify(getEventMessage(data, options)));
    });

    tailf.stderr.on("data", function(data) {
      console.log("Error", data.toString());
    });

    return this;

  },

  shutdown: function() {
    console.log("SHUTDOWN");
    tailf.kill();
    return this;
  }

};
